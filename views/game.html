<html>
    <head>
        <meta charset="UTF-8">
        <style>
            .hidden-canvas {
            display: none;
            }
        </style>
    </head>
    <body>
        <input type="file" id="fileInput">
        <div id = "buttons" class="buttons">
            <div id="asd" class="custom-button">
                asd
            </div>
            <div id="rew" class="custom-button">
                rew
            </div>
            <div id="zxc" class="custom-button">
                zxc
            </div>
        </div>
        <canvas id="myCanvas" class="hidden-canvas" width="800" height="600"></canvas>
        <canvas id="screen" width="400" height="400"></canvas>
        <div><input id="sentenceEdit"/></div><button id="send">말하기</button>
        <div id="meButton">나임을 확인</div>
        <div style="background: indianred;">
            <div id="talk0" style="width: 300px; height: 100px;"></div>
            <div id="talk1" style="width: 300px; height: 100px;"></div>
            <div id="talk2" style="width: 300px; height: 100px;"></div>
            <div id="talk3" style="width: 300px; height: 100px;"></div>
        </div>
        <script src="/socket.io/socket.io.js"></script> 
        <script>
            var canvas = document.getElementById('myCanvas');
            var screen = document.getElementById('screen');
            var ctx = canvas.getContext('2d');
            var pSrc = screen.getContext('2d');


            var b_img = new Image();

            var userImg1 = new Image();
            var userImg2 = new Image();
            var userImg3 = new Image();
            var userImg4 = new Image();

            b_img.src = 'pan.jpg';

            userImg1.src = 'dance/1.png';
            userImg2.src = 'dance/2.png';
            userImg3.src = 'dance/3.png';
            userImg4.src = 'dance/4.png';

            userImgList = [userImg1,userImg2,userImg3,userImg4];

            var userList = [];
            var userList_f = [];
            var userMe = 'asd';
            var userRoom = 'asd';
            var userMeImg = 0;

            var Mstate = 'y';
            var userXMove = 0;
            var userYMove = 0;

            var background = {
                x : 0,
                y : 0,
                width : 800,
                height : 600,
                draw(){
                    ctx.drawImage(b_img,0,0);
                }
            }

            const socket = io();

            document.getElementById('asd').addEventListener('click',function(e){
                var Hcanvas = document.getElementById("myCanvas");
                Hcanvas.classList.toggle("hidden-canvas");
                userRoom = 'asd';
                socket.emit("room",'asd');
                gameLoop();
            });

            document.getElementById('rew').addEventListener('click',function(e){
                var Hcanvas = document.getElementById("myCanvas");
                Hcanvas.classList.toggle("hidden-canvas");
                userRoom = 'rew';
                socket.emit("room",'rew');
                gameLoop();
            });

            document.getElementById('zxc').addEventListener('click',function(e){
                var Hcanvas = document.getElementById("myCanvas");
                Hcanvas.classList.toggle("hidden-canvas");
                userRoom = 'zxc';
                socket.emit("room",'zxc');
                gameLoop();
            });

            document.getElementById('meButton').addEventListener('click',function(e){
                alert(userMe);
            });

            // 유저 생성 함수
            function createUser(id, x, y,Sn) {
                userList.push({ id, x, y, width: 100, height: 100, speed: 200, imgSn : Sn});
                console.log(userList.length);
                console.log('생성됨');
            }

            socket.on("guestList", (guestList,guest,userListt,userImgSn)=>{
                alert(guest);
                userMe = guest;
                userMeImg = userImgSn;
                //기존유저생성
                createUser(guest,50,50,userImgSn);
                console.log(userImgSn);
                for (let i = userListt.length - 1; i >= 0; i--){
                    createUser(userListt[i].id,userListt[i].x,userListt[i].y,userListt[i].imgSn);
                }
                //유저 백엔드로 보내기
                socket.emit("updateGuestListOne",userList);
            });


            //서버수신
            socket.on("updateGuestList", (List)=>{
                console.log('업데이트됩니다');
                userList = List;
                userList_f = List;
            });


            //누군가 나갔을 때 서버수신
            socket.on("bye",(id) =>{
                for (let i = userList.length - 1; i >= 0; i--){
                    if(userList[i].id === id){
                        userList.splice(i,1);
                    }
                }
                socket.emit("updateGuestListOne",userList);
                console.log('누군가 나감');
                console.log(userList);
            });


            //키다운이벤트 플레이어 서버송신
            document.addEventListener('keydown',function(e){
                ctx.clearRect(0,0,canvas.width,canvas.height);
                if (e.code == 37 || e.key == "ArrowRight"){
                    Mstate = 'x';
                    userXMove = 200;
                    console.log(userList.length);
                } else if(e.key == 39 || e.key == "ArrowLeft") {
                    Mstate = 'x';
                    userXMove = -200;
                }
                else if(e.key == 38 || e.key == "ArrowUp") {
                    Mstate = 'y';
                    userYMove = -200;
                }
                else if(e.key == 40 || e.key == "ArrowDown") {
                    Mstate = 'y';
                    userYMove = 200;
                }
                for (let i = userList.length - 1; i >= 0; i--){
                        const user = userList[i];
                        console.log(userList.length);
                        console.log(user.id);
                        if(user.id === userMe){
                            if(Mstate == 'x'){
                                console.log('asdasdas');
                                console.log(user.id);
                                socket.emit("updateGuestList",user,userXMove,0);
                                Mstate = 't'
                            }else if(Mstate == 'y'){
                                socket.emit("updateGuestList",user,0,userYMove);
                                Mstate = 't'
                            }
                        }
                    }
            })


            //메세지를 백엔드에서 프론드로받음
            socket.on("talkF",(sentence, userSentneceIdx)=>{
                // 부모 요소 선택
                var parentElement = document.getElementById('talk'+userSentneceIdx);

                // 이전의 <div> 삭제
                var divToRemove = parentElement.querySelector("div");
                if (divToRemove) {
                    divToRemove.remove(); // divToRemove가 있는 경우에만 삭제
                }

                // 새로운 <div> 추가
                parentElement.insertAdjacentHTML("beforeend", `<div>${sentence}</div>`);
            })

            document.querySelector('#send').addEventListener('click',function(e){

                // 문장 가져오기
                let sentenceElement = document.getElementById('sentenceEdit');
                let sentence = sentenceElement ? sentenceElement.value : ''; // sentenceElement가 없으면 빈 문자열 반환
                //메세지를 백엔드로 송신
                socket.emit("talkB",sentence, userMeImg  );
            
            })  


            //이미지를 백엔드에서 프론드로받음
            socket.on("screenF",(screenData)=>{
                var screenImg = new Image();
                screenImg.src = screenData;
                //screenImg가 로드 될때 drawImage
                screenImg.onload = function() {
                    pSrc.drawImage(screenImg, 0, 0);              
                };            
            })

            document.getElementById('fileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 이미지 파일을 읽고 Socket.IO를 통해 서버에 전송합니다.
                    socket.emit('screenB', e.target.result);
                };
                reader.readAsDataURL(file);
            });


            function gameLoop() {
                //console.log('asdasd');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                background.draw();
                for (let i = userList_f.length - 1; i >= 0; i--){
                    //console.log(userList_f[i]);
                    const user = userList_f[i];
                    ctx.drawImage(userImgList[user.imgSn],user.x,user.y);
                }
                requestAnimationFrame(gameLoop);
            }

        </script>
    </body>
</html>